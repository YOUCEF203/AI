<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>المساعد الذكي</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        :root {
            --primary-hue: 220;
            --primary-saturation: 85%;
            --primary-lightness: 58%;
            --primary-color: hsl(var(--primary-hue), var(--primary-saturation), var(--primary-lightness));
            --primary-dark: hsl(var(--primary-hue), var(--primary-saturation), 50%);
            --primary-light: hsl(var(--primary-hue), var(--primary-saturation), 96%);
            --primary-glow: 0 0 25px -5px hsl(var(--primary-hue), var(--primary-saturation), calc(var(--primary-lightness) + 5%));
            
            --text-dark-primary: #111827;
            --text-dark-secondary: #4b5563;
            --text-light-primary: #f9fafb;
            --text-light-secondary: #d1d5db;
            
            --bg-light: #f8f9fa;
            --bg-dark: #121212;
            --surface-light: #ffffff;
            --surface-dark: #1e1e1e;
            --border-light: #e9ecef;
            --border-dark: #2c2c2c;
            
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
            
            --border-radius-sm: 0.5rem;
            --border-radius-md: 0.75rem;
            --border-radius-lg: 1rem;
            
            --transition-fast: all 0.2s ease-in-out;
            --transition-slow: all 0.3s ease-in-out;
        }

        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        body {
            background-color: var(--bg-light);
            color: var(--text-dark-primary);
            transition: var(--transition-slow);
            overflow: hidden;
            font-family: 'Inter', 'Tajawal', sans-serif;
        }
        body.dark-mode {
            background-color: var(--bg-dark);
            color: var(--text-light-primary);
        }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border-light); border-radius: 4px; }
        body.dark-mode ::-webkit-scrollbar-thumb { background: var(--border-dark); }
        ::-webkit-scrollbar-thumb:hover { background: #ced4da; }
        body.dark-mode ::-webkit-scrollbar-thumb:hover { background: #495057; }
        
        .app-layout { position: relative; display: flex; height: 100vh; width: 100vw; overflow: hidden; }
        
        .sidebar {
            width: 300px;
            flex-shrink: 0;
            background-color: var(--surface-light);
            border-left: 1px solid var(--border-light);
            display: flex;
            flex-direction: column;
            padding: 1.5rem;
            transition: var(--transition-slow);
            z-index: 1001;
        }
        body.dark-mode .sidebar { background-color: var(--surface-dark); border-left-color: var(--border-dark); }
        .app-layout.sidebar-collapsed .sidebar { width: 0; padding: 1.5rem 0; opacity: 0; transform: translateX(20px);}
        html[dir="ltr"] .app-layout.sidebar-collapsed .sidebar { transform: translateX(-20px); }

        .main-content { flex-grow: 1; display: flex; flex-direction: column; height: 100vh; background-color: var(--bg-light); transition: var(--transition-slow); }
        body.dark-mode .main-content { background-color: var(--bg-dark); }
        .sidebar-header { display: flex; align-items: center; gap: 0.75rem; margin-bottom: 2rem; }
        .logo-icon {
            width: 44px; height: 44px; background: var(--primary-color); border-radius: 50%;
            display: grid; place-items: center; color: white; font-size: 1.75rem; flex-shrink: 0;
        }
        .logo-title { font-size: 1.5rem; font-weight: 800; white-space: nowrap; }
        .new-chat-btn {
            display: flex; align-items: center; justify-content: center; gap: 0.5rem; width: 100%; padding: 0.8rem 1rem;
            font-size: 1rem; font-weight: 600; background: var(--primary-color); color: white; border: none;
            border-radius: var(--border-radius-md); cursor: pointer; transition: var(--transition-fast); margin-bottom: 1.5rem; white-space: nowrap;
            box-shadow: var(--shadow-sm);
        }
        .new-chat-btn:hover { background: var(--primary-dark); transform: translateY(-2px); box-shadow: var(--primary-glow); }
        
        .history-container { flex: 1; overflow-y: auto; display: flex; flex-direction: column;}
        .history-title { font-size: 0.8rem; font-weight: 700; color: var(--text-dark-secondary); margin-bottom: 1rem; text-transform: uppercase; letter-spacing: 0.05em;}
        body.dark-mode .history-title { color: var(--text-light-secondary); }
        .chat-history, .developers-list { list-style: none; margin: 0; padding: 0;}
        .chat-history { margin-bottom: 1.5rem; }
        .chat-history-item {
            display: flex; align-items: center; justify-content: space-between; gap: 0.5rem; padding: 0.75rem;
            border-radius: var(--border-radius-sm); margin-bottom: 0.5rem; cursor: pointer;
            transition: var(--transition-fast);
        }
        .chat-history-item .chat-title {
            flex-grow: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            font-size: 0.95rem; font-weight: 500; color: var(--text-dark-secondary);
        }
        body.dark-mode .chat-history-item .chat-title { color: var(--text-light-secondary); }
        .chat-history-item .delete-chat-btn {
            background: none; border: none; color: var(--text-dark-secondary); cursor: pointer;
            font-size: 1.1rem; opacity: 0; transition: var(--transition-fast);
        }
        body.dark-mode .chat-history-item .delete-chat-btn { color: var(--text-light-secondary); }
        .chat-history-item:hover .delete-chat-btn { opacity: 0.6; }
        .chat-history-item .delete-chat-btn:hover { opacity: 1; color: #ef4444; }
        
        .developer-item {
            display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem;
            border-radius: var(--border-radius-sm); margin-bottom: 0.5rem; font-size: 0.95rem; font-weight: 500; cursor: pointer;
            transition: var(--transition-fast); white-space: nowrap; color: var(--text-dark-secondary);
        }
        .developer-item a { color: inherit; text-decoration: none; display: flex; align-items: center; gap: 0.75rem; width: 100%;}
        .chat-history-item:hover, .developer-item:hover { background-color: var(--bg-light); color: var(--text-dark-primary); }
        body.dark-mode .chat-history-item:hover, body.dark-mode .developer-item:hover { background-color: var(--border-dark); color: var(--text-light-primary); }
        .chat-history-item.active { background-color: var(--primary-light); }
        .chat-history-item.active .chat-title { color: var(--primary-dark); font-weight: 600; }
        body.dark-mode .chat-history-item.active { background-color: hsl(var(--primary-hue), 20%, 25%); }
        body.dark-mode .chat-history-item.active .chat-title { color: var(--text-light-primary); }
        
        .icon-btn {
            background: none; border: none; cursor: pointer; font-size: 1.5rem;
            color: var(--text-dark-secondary); transition: var(--transition-fast);
        }
        .icon-btn:hover { color: var(--primary-color); transform: scale(1.1); }
        body.dark-mode .icon-btn { color: var(--text-light-secondary); }
        body.dark-mode .icon-btn:hover { color: var(--primary-color); }
        
        .chat-container { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; }
        .chat-header {
            display: flex; align-items: center; justify-content: space-between; padding: 0.75rem 1.5rem; border-bottom: 1px solid var(--border-light);
        }
        body.dark-mode .chat-header { border-bottom-color: var(--border-dark); }
        
        .service-dropdown { position: relative; }
        .current-service-btn {
            background: var(--bg-light); border: 1px solid var(--border-light); font-size: 1.1rem; font-weight: 600;
            display: flex; align-items: center; gap: 0.5rem; cursor: pointer;
            padding: 0.5rem 1rem; border-radius: var(--border-radius-sm); transition: var(--transition-fast);
        }
        body.dark-mode .current-service-btn { background: var(--surface-dark); border-color: var(--border-dark); }
        .dropdown-menu {
            position: absolute; top: 120%; left: 50%; transform: translateX(-50%);
            background-color: var(--surface-light); border: 1px solid var(--border-light);
            border-radius: var(--border-radius-md); box-shadow: var(--shadow-lg);
            min-width: 220px; z-index: 10;
            opacity: 0; visibility: hidden; transform: translateX(-50%) translateY(10px);
            transition: var(--transition-fast);
        }
        body.dark-mode .dropdown-menu { background-color: var(--surface-dark); border-color: var(--border-dark); }
        .dropdown-menu.open { opacity: 1; visibility: visible; transform: translateX(-50%) translateY(0); }
        .dropdown-item {
            display: flex; width: 100%; align-items: center; gap: 0.75rem;
            padding: 0.75rem 1rem; background: none; border: none;
            font-size: 1rem; text-align: right; cursor: pointer;
        }
        html[dir="ltr"] .dropdown-item { text-align: left; }
        .dropdown-item:hover { background-color: var(--primary-light); }
        body.dark-mode .dropdown-item:hover { background-color: hsl(var(--primary-hue), 20%, 25%); }

        .chat-messages { flex-grow: 1; padding: 2rem; overflow-y: auto; display: flex; flex-direction: column; gap: 1.5rem; }
        .message { display: flex; gap: 1rem; max-width: 90%; animation: message-fade-in 0.4s ease-out; position: relative; }
        .message-user { align-self: flex-end; flex-direction: row-reverse; }
        .message-ai { align-self: flex-start; max-width: 100%; width: 100%;}
        .avatar { width: 40px; height: 40px; border-radius: 50%; flex-shrink: 0; display: grid; place-items: center; font-size: 1.4rem; color: white; }
        .user-avatar { background: linear-gradient(45deg, hsl(var(--primary-hue), 90%, 65%), hsl(var(--primary-hue), 80%, 55%)); }
        .ai-avatar { background: var(--primary-color); }
        .message-content { width: 100%; padding: 0.8rem 1.2rem; border-radius: var(--border-radius-lg); line-height: 1.7; word-wrap: break-word; box-shadow: var(--shadow-sm); }
        .message-content img { max-width: 100%; border-radius: var(--border-radius-md); margin-top: 0.5rem; }
        .message-user .message-content {
            background-image: linear-gradient(to right, hsl(var(--primary-hue), 90%, 70%), hsl(var(--primary-hue), 80%, 60%));
            color: white; border-top-right-radius: var(--border-radius-sm); width: auto; animation: gradient-animation 5s ease infinite; background-size: 200% 200%;
        }
        html[dir="ltr"] .message-user .message-content { border-top-left-radius: var(--border-radius-sm); border-top-right-radius: var(--border-radius-lg); }
        .message-ai .message-content { background-color: var(--surface-light); border: 1px solid var(--border-light); border-top-left-radius: var(--border-radius-sm); }
        html[dir="ltr"] .message-ai .message-content { border-top-right-radius: var(--border-radius-sm); border-top-left-radius: var(--border-radius-lg); }
        body.dark-mode .message-ai .message-content { background-color: var(--surface-dark); border-color: var(--border-dark); }
        .message.error .message-content { background-color: #fee2e2; color: #b91c1c; font-weight: 500; width: auto; box-shadow: none;}
        body.dark-mode .message.error .message-content { background-color: #3f1a1a; color: #fca5a5; }
        .message.typing .message-content { color: var(--text-dark-secondary); font-style: italic; width: auto; background: none; box-shadow: none; border: none;}
        body.dark-mode .message.typing .message-content { color: var(--text-light-secondary); }

        .website-wrapper { border-radius: var(--border-radius-lg); overflow: hidden; border: 1px solid var(--border-light); box-shadow: var(--shadow-md); }
        body.dark-mode .website-wrapper { border-color: var(--border-dark); }
        .website-tabs { display: flex; background-color: var(--bg-light); padding: 0.5rem; gap: 0.5rem; border-bottom: 1px solid var(--border-light); }
        body.dark-mode .website-tabs { background-color: var(--bg-dark); border-bottom-color: var(--border-dark); }
        .website-tab { padding: 0.6rem 1rem; cursor: pointer; border-radius: var(--border-radius-sm); transition: var(--transition-fast); font-weight: 500;}
        .website-tab.active { background-color: var(--surface-light); color: var(--primary-dark); box-shadow: var(--shadow-sm); }
        body.dark-mode .website-tab.active { background-color: var(--surface-dark); color: var(--primary-color); }
        .website-content { display: none; }
        .website-content.active { display: block; }
        .website-preview iframe { width: 100%; height: 500px; border: none; }
        .website-code { position: relative; }
        .website-code pre { background-color: #111827; color: #f3f4f6; padding: 1.5rem; white-space: pre-wrap; word-wrap: break-word; max-height: 500px; overflow: auto; margin: 0; border-radius: 0; }
        .copy-code-btn { position: absolute; top: 1rem; background: rgba(255,255,255,0.1); color: white; border: none; padding: 0.4rem 0.6rem; border-radius: var(--border-radius-sm); cursor: pointer; font-size: 0.8rem; transition: var(--transition-fast); }
        html[dir="rtl"] .copy-code-btn { left: 1rem; }
        html[dir="ltr"] .copy-code-btn { right: 1rem; }
        .copy-code-btn:hover { background: rgba(255,255,255,0.2); }
        
        .input-area { padding: 1rem 1.5rem; border-top: 1px solid var(--border-light); background: var(--surface-light); }
        body.dark-mode .input-area { border-top-color: var(--border-dark); background: var(--surface-dark); }
        .input-wrapper { display: flex; align-items: center; gap: 1rem; }
        .chat-input {
            flex-grow: 1; padding: 0.8rem 1.2rem; border: 1px solid var(--border-light);
            border-radius: 24px; font-size: 1rem; resize: none; min-height: 48px;
            background-color: var(--bg-light); color: var(--text-dark-primary); transition: var(--transition-fast);
        }
        body.dark-mode .chat-input { background-color: var(--surface-dark); border-color: var(--border-dark); color: var(--text-light-primary); }
        .chat-input:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px hsl(var(--primary-hue), var(--primary-saturation), 50%, 0.1); }
        .send-btn {
            background: var(--primary-color); color: white; border: none; border-radius: 50%;
            width: 48px; height: 48px; display: grid; place-items: center; flex-shrink: 0;
            cursor: pointer; font-size: 1.4rem; transition: var(--transition-fast);
        }
        .send-btn:hover { transform: scale(1.1); box-shadow: var(--primary-glow); }
        .send-btn:disabled { background-color: #9ca3af; cursor: not-allowed; transform: scale(1); box-shadow: none; }
        
        @media (max-width: 768px) {
            .sidebar { position: fixed; top: 0; right: 0; height: 100%; transform: translateX(100%); box-shadow: var(--shadow-lg); background-color: rgba(255, 255, 255, 0.8); backdrop-filter: blur(10px); }
            html[dir="ltr"] .sidebar { right: auto; left: 0; transform: translateX(-100%); }
            body.dark-mode .sidebar { background-color: rgba(30, 30, 30, 0.8); }
            .sidebar.open { transform: translateX(0); }
            .menu-btn { display: grid; }
            .overlay { position: fixed; inset: 0; background-color: rgba(0,0,0,0.3); backdrop-filter: blur(4px); z-index: 1000; opacity: 0; visibility: hidden; transition: var(--transition-slow); }
            .overlay.active { opacity: 1; visibility: visible; }
        }

        .modal-overlay { position: fixed; inset: 0; background-color: rgba(0,0,0,0.3); backdrop-filter: blur(8px); display: grid; place-items: center; z-index: 1002; opacity: 0; visibility: hidden; transition: var(--transition-slow); }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal {
            background-color: var(--surface-light); border-radius: var(--border-radius-lg);
            width: 90%; max-width: 600px; box-shadow: var(--shadow-lg);
            transform: scale(0.95) translateY(20px); transition: var(--transition-slow);
            display: flex; flex-direction: column; max-height: 90vh;
        }
        .modal-overlay.active .modal { transform: scale(1) translateY(0); }
        body.dark-mode .modal { background-color: rgba(30, 30, 30, 0.9); border: 1px solid var(--border-dark); }
        .modal-header { padding: 1.5rem; border-bottom: 1px solid var(--border-light); display: flex; justify-content: space-between; align-items: center; }
        body.dark-mode .modal-header { border-bottom-color: var(--border-dark); }
        .modal-title { font-size: 1.25rem; font-weight: 700; display: flex; align-items: center; gap: 0.75rem; }
        .modal-body { padding: 1.5rem; display: grid; grid-template-columns: 1fr; gap: 2rem; overflow-y: auto; }
        @media (min-width: 640px) { .modal-body { grid-template-columns: 1fr 1fr; } }
        .settings-section { display: flex; flex-direction: column; gap: 1.5rem; }
        .settings-section-title { font-weight: 600; font-size: 1.1rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--border-light); }
        body.dark-mode .settings-section-title { border-bottom-color: var(--border-dark); }
        .setting-item { display: flex; flex-direction: column; gap: 0.75rem; }
        .setting-item > label { font-size: 1rem; font-weight: 500; display: flex; align-items: center; gap: 0.5rem; }
        .setting-item .slider-value { font-weight: 600; color: var(--primary-color); }
        select, .color-palette, input[type="text"], input[type="range"] {
            width: 100%; padding: 0.6rem; border-radius: var(--border-radius-sm); border: 1px solid var(--border-light);
            background-color: var(--bg-light); font-size: 1rem;
        }
        input[type="range"] { -webkit-appearance: none; appearance: none; background: transparent; cursor: pointer; padding: 0;}
        input[type="range"]::-webkit-slider-runnable-track { height: 6px; background: var(--border-light); border-radius: 3px; }
        input[type="range"]::-moz-range-track { height: 6px; background: var(--border-light); border-radius: 3px; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; margin-top: -5px; background-color: var(--primary-color); height: 16px; width: 16px; border-radius: 50%; }
        input[type="range"]::-moz-range-thumb { border: none; border-radius: 50%; background-color: var(--primary-color); height: 16px; width: 16px; }

        body.dark-mode select, body.dark-mode .color-palette, body.dark-mode input[type="text"], body.dark-mode input[type="range"]::-webkit-slider-runnable-track { background-color: var(--surface-dark); border-color: var(--border-dark); color: var(--text-light-primary); }
        body.dark-mode input[type="range"]::-moz-range-track { background-color: var(--border-dark); }
        
        .color-palette { display: flex; gap: 0.5rem; align-items: center; }
        .color-swatch { width: 24px; height: 24px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; transition: var(--transition-fast); }
        .color-swatch.active { border-color: var(--primary-color); transform: scale(1.1); }
        input[type="color"] { width: 32px; height: 32px; border: none; background: none; padding: 0; border-radius: 50%; cursor: pointer; }
        input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
        input[type="color"]::-webkit-color-swatch { border: none; border-radius: 50%; }

        .dark-mode-toggle { display: flex; align-items: center; justify-content: space-between; }
        .switch { position: relative; display: inline-block; width: 50px; height: 28px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary-color); }
        input:focus + .slider { box-shadow: 0 0 1px var(--primary-color); }
        input:checked + .slider:before { transform: translateX(22px); }

        .modal-footer { padding: 1rem 1.5rem; display: flex; justify-content: flex-end; border-top: 1px solid var(--border-light); background-color: var(--bg-light); border-radius: 0 0 var(--border-radius-lg) var(--border-radius-lg); }
        body.dark-mode .modal-footer { border-top-color: var(--border-dark); background-color: var(--bg-dark); }
        
        @keyframes message-fade-in { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes gradient-animation { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
    </style>
</head>
<body>
    <div class="app-layout" id="app-layout">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo-icon"><i class="ph-duotone ph-brain"></i></div>
                <h1 class="logo-title" data-translate-key="appTitle">المساعد الذكي</h1>
            </div>
            <button class="new-chat-btn"><i class="ph ph-plus"></i><span data-translate-key="newChat">محادثة جديدة</span></button>
            <div class="history-container">
                <div>
                    <h3 class="history-title" data-translate-key="history">الأرشيف</h3>
                    <ul class="chat-history"></ul>
                </div>
                <div style="margin-top: auto; padding-top: 1rem;">
                     <h3 class="history-title" data-translate-key="developers">المطورون</h3>
                     <ul class="developers-list">
                        <li class="developer-item">
                           <a href="https://www.facebook.com/youcef.youcef.209664/?locale=ar_AR" target="_blank" rel="noopener noreferrer">
                                <i class="ph ph-user-circle"></i><span>YOUCEF HD</span>
                           </a>
                        </li>
                        <li class="developer-item" style="cursor: default;">
                           <i class="ph ph-user-circle"></i><span>mouad معاذ</span>
                        </li>
                     </ul>
                </div>
            </div>
        </aside>

        <main class="main-content">
            <header class="chat-header">
                <div class="header-left">
                    <button class="icon-btn menu-btn" id="menu-btn"><i class="ph ph-list"></i></button>
                </div>
                <div class="service-dropdown" id="service-dropdown">
                    <button class="current-service-btn">
                        <span id="current-service-name">Gemini</span>
                        <i class="ph ph-caret-down"></i>
                    </button>
                    <div class="dropdown-menu">
                        <button class="dropdown-item" data-service="gemini">Gemini</button>
                        <button class="dropdown-item" data-service="image" data-translate-key="imageService">صناعة الصور</button>
                        <button class="dropdown-item" data-service="website" data-translate-key="websiteService">إنشاء موقع</button>
                        <button class="dropdown-item" data-service="voice" data-translate-key="voiceService">تحويل النص لصوت</button>
                    </div>
                </div>
                <div class="header-actions">
                    <button class="icon-btn" id="settings-btn" title="الإعدادات"><i class="ph ph-gear"></i></button>
                </div>
            </header>
            <div class="chat-container">
                <div class="chat-messages"></div>
                <div class="input-area">
                    <div class="input-wrapper" id="input-wrapper">
                        <!-- Input area dynamically updated by JS -->
                    </div>
                </div>
            </div>
        </main>
        <div class="overlay" id="overlay"></div>
    </div>

    <div class="modal-overlay" id="settings-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title"><i class="ph ph-gear-six"></i><span data-translate-key="settings">الإعدادات</span></h3>
                <button class="icon-btn modal-close"><i class="ph ph-x"></i></button>
            </div>
            <div class="modal-body">
                 <div class="settings-section">
                    <h4 class="settings-section-title" data-translate-key="generalSettings">إعدادات عامة</h4>
                    <div class="setting-item">
                        <label for="language-select"><i class="ph ph-translate"></i><span data-translate-key="interfaceLanguage">لغة الواجهة</span></label>
                        <select id="language-select">
                            <option value="ar">العربية</option><option value="en">English</option>
                        </select>
                    </div>
                    <div class="setting-item">
                        <label><i class="ph ph-palette"></i><span data-translate-key="primaryColor">اللون الأساسي</span></label>
                        <div class="color-palette">
                             <span class="color-swatch" data-color="#6366f1" style="background-color: #6366f1;"></span>
                             <span class="color-swatch" data-color="#ec4899" style="background-color: #ec4899;"></span>
                             <span class="color-swatch" data-color="#22c55e" style="background-color: #22c55e;"></span>
                             <span class="color-swatch" data-color="#f97316" style="background-color: #f97316;"></span>
                             <input type="color" id="color-picker">
                        </div>
                    </div>
                     <div class="setting-item dark-mode-toggle">
                        <label for="dark-mode-toggle"><i class="ph ph-moon"></i><span data-translate-key="darkMode">المظهر الداكن</span></label>
                        <label class="switch">
                          <input type="checkbox" id="dark-mode-toggle">
                          <span class="slider"></span>
                        </label>
                    </div>
                </div>
                <div class="settings-section" id="audio-settings-section">
                    <h4 class="settings-section-title" data-translate-key="audioSettings">إعدادات الصوت</h4>
                    <div class="setting-item">
                        <label for="audio-voice-select"><i class="ph ph-speaker-high"></i><span data-translate-key="voice">الصوت</span></label>
                        <select id="audio-voice-select">
                            <option value="alloy">Alloy</option><option value="echo">Echo</option>
                            <option value="fable">Fable</option><option value="onyx">Onyx</option>
                            <option value="nova">Nova</option><option value="shimmer">Shimmer</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="save-btn new-chat-btn" data-translate-key="close">إغلاق</button>
            </div>
        </div>
    </div>
    
<script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- Security Measures ---
        document.addEventListener('contextmenu', event => event.preventDefault());
        document.addEventListener('keydown', event => {
            if (event.key === 'F12' || (event.ctrlKey && event.shiftKey && ['I', 'J', 'C'].includes(event.key.toUpperCase())) || (event.ctrlKey && event.key.toUpperCase() === 'U')) {
                event.preventDefault();
            }
        });

        const getEl = (id) => document.getElementById(id);
        const queryEl = (sel) => document.querySelector(sel);
        
        const inputWrapper = getEl('input-wrapper');
        const chatHistoryList = queryEl('.chat-history');
        const chatMessages = queryEl('.chat-messages');
        const newChatBtn = queryEl('.new-chat-btn');
        const settingsBtn = getEl('settings-btn');
        const settingsModal = getEl('settings-modal');
        const closeModalBtn = queryEl('#settings-modal .modal-close');
        const saveSettingsBtn = queryEl('#settings-modal .save-btn');
        const menuBtn = getEl('menu-btn');
        const sidebar = getEl('sidebar');
        const overlay = getEl('overlay');
        const serviceDropdown = getEl('service-dropdown');
        const currentServiceSpan = getEl('current-service-name');
        const dropdownMenu = queryEl('.dropdown-menu');

        // Settings Elements
        const languageSelect = getEl('language-select');
        const colorPicker = getEl('color-picker');
        const colorSwatches = document.querySelectorAll('.color-swatch');
        const darkModeToggle = getEl('dark-mode-toggle');
        const audioVoiceSelect = getEl('audio-voice-select');

        let appData = {};
        const GEMINI_API_KEY = 'AIzaSyA_X5m2T_oDPsc-D2JiSKKJ-jJKvvJLmH8';

        const uiStrings = {
             ar: { appTitle: "المساعد الذكي", newChat: "محادثة جديدة", history: "الأرشيف", settings: "الإعدادات", language: "اللغة", interfaceLanguage: "لغة الواجهة", primaryColor: "اللون الأساسي", saveChanges: "حفظ وإغلاق", close: "إغلاق", welcomeMsg: "أهلاً بك. اختر خدمة للبدء.", newChatWelcome: "أهلاً بك في محادثة جديدة! كيف يمكنني مساعدتك اليوم؟", errorMsg: "عذراً، حدث خطأ:", apiError: "لم أتلق رداً صالحاً من الخادم.", imageService: "صناعة الصور", websiteService: "إنشاء موقع", voiceService: "تحويل النص لصوت", audioSettings: "إعدادات الصوت", voice: "الصوت", download: "تحميل", developers: "المطورون", typing: "يقوم الذكاء الاصطناعي بالكتابة...", generatingKeywords: "جاري تحسين الوصف...", generatingImage: "جاري إنشاء الصورة...", analyzingRequest: "جاري تحليل طلبك...", buildingWebsite: "جاري بناء الموقع...", enhancingIdea: "جاري توسيع الفكرة...", preview: "معاينة", code: "الكود", copyCode: "نسخ الكود", codeCopied: "تم النسخ!", placeholderText: "اسأل أي شيء...", placeholderImage: "اكتب وصفاً للصورة...", placeholderWebsite: "صف فكرة موقعك...", placeholderVoice: "اكتب نصاً لتحويله إلى صوت...", generalSettings: "إعدادات عامة", darkMode: "المظهر الداكن" },
             en: { appTitle: "Smart Assistant", newChat: "New Chat", history: "History", settings: "Settings", language: "Language", interfaceLanguage: "Interface Language", primaryColor: "Primary Color", saveChanges: "Save & Close", close: "Close", welcomeMsg: "Welcome. Select a service to begin.", newChatWelcome: "Welcome to a new chat! How can I help you today?", errorMsg: "Sorry, an error occurred:", apiError: "Invalid response received from the server.", imageService: "Image Generation", websiteService: "Website Builder", voiceService: "Text-to-Speech", audioSettings: "Audio Settings", voice: "Voice", download: "Download", developers: "Developers", typing: "AI is typing...", generatingKeywords: "Optimizing prompt...", generatingImage: "Generating image...", analyzingRequest: "Analyzing your request...", buildingWebsite: "Building your website...", enhancingIdea: "Enhancing the idea...", preview: "Preview", code: "Code", copyCode: "Copy Code", codeCopied: "Copied!", placeholderText: "Ask anything...", placeholderImage: "Describe an image...", placeholderWebsite: "Describe your website idea...", placeholderVoice: "Type text to convert to speech...", generalSettings: "General Settings", darkMode: "المظهر الداكن" },
        };
        
        const init = () => {
            setupEventListeners();
            loadAppData();
        };

        const setupEventListeners = () => {
            inputWrapper.addEventListener('click', (e) => { if (e.target.closest('.send-btn')) handleSendMessage(); });
            inputWrapper.addEventListener('keydown', (e) => { if (e.target.classList.contains('chat-input') && e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSendMessage(); } });
            newChatBtn.addEventListener('click', startNewChat);
            settingsBtn.addEventListener('click', () => settingsModal.classList.add('active'));
            closeModalBtn.addEventListener('click', () => settingsModal.classList.remove('active'));
            saveSettingsBtn.addEventListener('click', () => settingsModal.classList.remove('active'));
            menuBtn.addEventListener('click', () => { sidebar.classList.add('open'); overlay.classList.add('active'); });
            overlay.addEventListener('click', () => { sidebar.classList.remove('open'); overlay.classList.remove('active'); });
            serviceDropdown.addEventListener('click', (e) => { if (e.target.closest('.current-service-btn')) { dropdownMenu.classList.toggle('open'); } });
            dropdownMenu.addEventListener('click', (e) => { if (e.target.classList.contains('dropdown-item') && !e.target.disabled) { setActiveService(e.target.dataset.service); dropdownMenu.classList.remove('open'); } });
            document.addEventListener('click', (e) => { if (!serviceDropdown.contains(e.target)) { dropdownMenu.classList.remove('open'); } });

            // Settings Listeners
            darkModeToggle.addEventListener('change', (e) => { appData.settings.darkMode = e.target.checked; saveAndApplyData(); });
            languageSelect.addEventListener('change', (e) => { appData.settings.language = e.target.value; saveAndApplyData(); });
            colorPicker.addEventListener('input', (e) => { updatePrimaryColor(e.target.value); });
            colorSwatches.forEach(swatch => swatch.addEventListener('click', () => updatePrimaryColor(swatch.dataset.color)));
            audioVoiceSelect.addEventListener('change', (e) => { appData.settings.audioVoice = e.target.value; saveAndApplyData(); });
        };
        
        const updatePrimaryColor = (color) => {
            appData.settings.primaryColor = color;
            colorPicker.value = color;
            saveAndApplyData();
        };

        const loadAppData = () => {
            let savedData;
            try { savedData = JSON.parse(localStorage.getItem('aiAssistantData')); } catch (e) { savedData = null; }
            const defaultSettings = { darkMode: false, language: 'ar', primaryColor: '#6366f1', activeService: 'gemini', audioVoice: 'alloy' };
            if (savedData && savedData.chats && savedData.chats.length > 0) {
                appData = savedData;
                appData.settings = { ...defaultSettings, ...savedData.settings };
            } else {
                const initialChatId = `chat-${Date.now()}`;
                appData = {
                    settings: defaultSettings,
                    activeChatId: initialChatId,
                    chats: [{ id: initialChatId, title: uiStrings[defaultSettings.language].newChat, history: [] }]
                };
            }
            applySettings();
            renderChatHistory();
            loadActiveChat();
        };
        
        const saveAndApplyData = () => {
            localStorage.setItem('aiAssistantData', JSON.stringify(appData));
            applySettings();
            renderChatHistory();
        };
        
        const applySettings = () => {
            const settings = appData.settings;
            document.body.classList.toggle('dark-mode', settings.darkMode);
            const [h, s, l] = hexToHsl(settings.primaryColor);
            document.documentElement.style.setProperty('--primary-hue', h);
            document.documentElement.style.setProperty('--primary-saturation', `${s}%`);
            document.documentElement.style.setProperty('--primary-lightness', `${l}%`);
            languageSelect.value = settings.language;
            colorPicker.value = settings.primaryColor;
            darkModeToggle.checked = settings.darkMode;
            updateColorSwatches(settings.primaryColor);
            audioVoiceSelect.value = settings.audioVoice;
            const serviceEl = queryEl(`.dropdown-item[data-service="${settings.activeService}"]`);
            if (serviceEl) { currentServiceSpan.textContent = serviceEl.textContent; }
            applyLanguage(settings.language);
        };
        
        const updateColorSwatches = (activeColor) => {
            colorSwatches.forEach(swatch => {
                if(swatch.dataset.color.toLowerCase() === activeColor.toLowerCase()){
                    swatch.classList.add('active');
                } else {
                    swatch.classList.remove('active');
                }
            });
        };

        const applyLanguage = (lang) => {
            document.documentElement.lang = lang;
            document.documentElement.dir = (lang === 'ar') ? 'rtl' : 'ltr';
            document.querySelectorAll('[data-translate-key]').forEach(el => {
                const key = el.dataset.translateKey;
                const strings = uiStrings[lang] || uiStrings.en;
                if (strings[key]) {
                    const value = strings[key];
                    if (el.placeholder !== undefined) { el.placeholder = value; } else { el.textContent = value; }
                }
            });
            updateInputArea();
        };

        const updateInputArea = () => {
            const lang = appData.settings.language;
            let placeholderKey = 'placeholderText';
            if (appData.settings.activeService === 'image') placeholderKey = 'placeholderImage';
            else if (appData.settings.activeService === 'website') placeholderKey = 'placeholderWebsite';
            else if (appData.settings.activeService === 'voice') placeholderKey = 'placeholderVoice';
            const strings = uiStrings[lang] || uiStrings.en;
            const html = `<textarea class="chat-input" placeholder="${strings[placeholderKey]}" rows="1"></textarea><button class="send-btn"><i class="ph ph-paper-plane-tilt"></i></button>`;
            inputWrapper.innerHTML = html;
        };

        const handleSendMessage = async () => {
            const inputEl = queryEl('.chat-input');
            const sendBtn = queryEl('.send-btn');
            const userMessage = inputEl.value.trim();
            if (!userMessage) return;
            const isFirstMessage = getActiveChat().history.length === 0;
            addMessageToHistory('user', userMessage);
            renderMessages(getActiveChat().history);
            inputEl.value = '';
            sendBtn.disabled = true;
            try {
                switch(appData.settings.activeService) {
                    case 'gemini': await handleChatService(); break;
                    case 'image': await handleImageService(userMessage); break;
                    case 'website': await handleWebsiteService(userMessage); break;
                    case 'voice': handleVoiceService(userMessage); break;
                }
                 if (isFirstMessage) { generateChatTitle(appData.activeChatId, userMessage); }
            } catch (error) {
                 console.error("Error during message handling:", error);
                 addMessage('error', error.message);
            } finally {
                if(sendBtn) sendBtn.disabled = false;
                if(inputEl) inputEl.focus();
            }
        };

        const handleChatService = async () => {
            const typingIndicator = addMessage('typing');
            try {
                const aiMessage = await sendToGemini(getActiveChat().history);
                addMessageToHistory('model', aiMessage);
                typingIndicator.remove();
                renderMessages(getActiveChat().history);
            } catch (error) {
                const strings = uiStrings[appData.settings.language] || uiStrings.en;
                typingIndicator.remove();
                getActiveChat().history.pop();
                addMessage('error', `${strings.errorMsg} ${error.message}`);
                saveAndApplyData();
            }
        };
        
        const handleImageService = async (userPrompt) => {
            const strings = uiStrings[appData.settings.language] || uiStrings.en;
            const statusIndicator = addMessage('typing', strings.generatingKeywords);
            try {
                const keywordGenerationPrompt = `You are an expert in creating prompts for image generation AIs. A user will provide a description. Your task is to translate it to English and then expand it into a detailed, comma-separated list of keywords focusing on visual elements. Only output the final list of keywords. Do not add any other text or explanation. Here is the description: "${userPrompt}"`;
                const keywords = await sendToGemini([{ role: 'user', parts: [{ text: keywordGenerationPrompt }] }]);
                statusIndicator.querySelector('.message-content').textContent = strings.generatingImage;
                const url = `https://image.pollinations.ai/prompt/${encodeURIComponent(keywords)}`;
                addMessageToHistory('model', url, 'image');
                statusIndicator.remove();
                renderMessages(getActiveChat().history);
            } catch (error) {
                statusIndicator.remove();
                getActiveChat().history.pop();
                throw new Error(`${strings.errorMsg} ${error.message}`);
            }
        };
        
        const handleWebsiteService = async (userPrompt) => {
            const strings = uiStrings[appData.settings.language] || uiStrings.en;
            let statusIndicator = addMessage('typing', strings.enhancingIdea);
            let finalPrompt = userPrompt;
            try {
                if (userPrompt.split(' ').length < 10) {
                    const enhancementPrompt = `You are a creative director. A user has a simple idea for a website: "${userPrompt}". Expand this into a more detailed, single-paragraph concept for a modern, visually appealing website. Describe the key sections, the overall vibe, and the target audience. Output only the paragraph.`;
                    finalPrompt = await sendToGemini([{ role: 'user', parts: [{ text: enhancementPrompt }] }]);
                }
                statusIndicator.querySelector('.message-content').textContent = strings.buildingWebsite;
                const websiteGenerationPrompt = `You are an expert web developer specializing in creating beautiful, modern, and responsive single-page websites using HTML and Tailwind CSS. The user wants a website based on this description: "${finalPrompt}". Your task is to generate a complete, single HTML file that includes the Tailwind CSS CDN link and all necessary HTML structure, content, and inline CSS classes. The design should be clean, professional, and mobile-first. Use high-quality placeholder images from https://placehold.co where appropriate. Do not include any explanation, just the raw HTML code starting with <!DOCTYPE html>.`;
                const websiteHtml = await sendToGemini([{ role: 'user', parts: [{ text: websiteGenerationPrompt }] }]);
                addMessageToHistory('model', websiteHtml, 'website');
                statusIndicator.remove();
                renderMessages(getActiveChat().history);
            } catch (error) {
                statusIndicator.remove();
                getActiveChat().history.pop();
                throw new Error(`${strings.errorMsg} ${error.message}`);
            }
        };

        const handleVoiceService = (text) => {
            const url = `https://text.pollinations.ai/${encodeURIComponent(text)}?model=openai-audio&voice=${appData.settings.audioVoice}`;
            addMessageToHistory('model', url, 'audio');
            renderMessages(getActiveChat().history);
        };

        const sendToGemini = async (history) => {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${GEMINI_API_KEY}`;
            const strings = uiStrings[appData.settings.language] || uiStrings.en;
            const payload = { contents: history.map(({type, ...rest}) => rest) };
            const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            const result = await response.json();
            if (!response.ok || !result.candidates?.[0]?.content?.parts?.[0]?.text) {
                const errorMessage = result.error?.message || strings.apiError;
                throw new Error(errorMessage);
            }
            return result.candidates[0].content.parts[0].text;
        };
        
        const renderMessages = (history) => {
            chatMessages.innerHTML = '';
            if(!history || history.length === 0) {
                 addMessage('ai', (uiStrings[appData.settings.language] || uiStrings.en).newChatWelcome);
            } else {
                 history.forEach(msg => addMessage(msg.role, msg.parts[0].text, msg.type || 'text'));
            }
        };

        const addMessage = (role, content = '', type = 'text') => {
            const messageRole = role === 'model' ? 'ai' : role;
            const messageEl = document.createElement('div');
            messageEl.className = `message message-${messageRole}`;
            let contentHTML = '';
            const strings = uiStrings[appData.settings.language] || uiStrings.en;
            
            switch (type) {
                case 'typing': contentHTML = content || strings.typing; break;
                case 'image': contentHTML = `<img src="${content}" alt="Generated image" onerror="this.parentElement.innerHTML = 'Image failed to load.'">`; break;
                case 'audio': contentHTML = `<div class="audio-player-wrapper"><audio controls autoplay src="${content}"></audio><a href="${content}" download="ai-voice.mp3" class="icon-btn" title="${strings.download}"><i class="ph ph-download-simple"></i></a></div>`; break;
                case 'website':
                    const uniqueId = `site-${Date.now()}`;
                    contentHTML = `<div class="website-wrapper" id="${uniqueId}"><div class="website-tabs"><div class="website-tab active" data-tab="preview">${strings.preview}</div><div class="website-tab" data-tab="code">${strings.code}</div></div><div class="website-content website-preview active" data-content="preview"><iframe srcdoc="${content.replace(/"/g, '&quot;')}" sandbox="allow-scripts allow-same-origin"></iframe></div><div class="website-content website-code" data-content="code"><button class="copy-code-btn">${strings.copyCode}</button><pre><code>${content.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</code></pre></div></div>`;
                    setTimeout(() => {
                        const wrapper = getEl(uniqueId);
                        wrapper.querySelectorAll('.website-tab').forEach(tab => tab.addEventListener('click', () => {
                            wrapper.querySelectorAll('.website-tab, .website-content').forEach(el => el.classList.remove('active'));
                            tab.classList.add('active');
                            wrapper.querySelector(`[data-content="${tab.dataset.tab}"]`).classList.add('active');
                        }));
                    }, 0);
                    break;
                default: contentHTML = content.replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/\n/g, '<br>');
            }
            
            const avatarIcon = messageRole === 'user' ? 'ph-user' : 'ph-brain';
            messageEl.innerHTML = `<div class="avatar user-avatar"><i class="ph ${avatarIcon}"></i></div><div class="message-content">${contentHTML}</div>`;
            if (messageRole !== 'user') messageEl.querySelector('.avatar').classList.replace('user-avatar', 'ai-avatar');
            chatMessages.appendChild(messageEl);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            return messageEl;
        };
        
        const addMessageToHistory = (role, content, type = 'text') => {
            const activeChat = getActiveChat();
            if (activeChat) {
                activeChat.history.push({ role, parts: [{ text: content }], type });
                saveAndApplyData();
            }
        };

        const renderChatHistory = () => {
            chatHistoryList.innerHTML = '';
            appData.chats.forEach(chat => {
                const item = document.createElement('li');
                item.className = 'chat-history-item';
                item.dataset.id = chat.id;
                if (chat.id === appData.activeChatId) item.classList.add('active');
                item.innerHTML = `<span class="chat-title">${chat.title}</span><button class="delete-chat-btn"><i class="ph ph-trash"></i></button>`;
                item.addEventListener('click', (e) => {
                    if (e.target.closest('.delete-chat-btn')) { e.stopPropagation(); deleteChat(chat.id); } 
                    else { switchChat(chat.id); }
                });
                chatHistoryList.appendChild(item);
            });
        };
        
        const generateChatTitle = async (chatId, prompt) => {
             const titlePrompt = `Summarize the following user prompt into a short, 3-4 word title. Respond with only the title, no extra text. Prompt: "${prompt}"`;
             try {
                const title = await sendToGemini([{role: 'user', parts: [{text: titlePrompt}]}]);
                const chat = appData.chats.find(c => c.id === chatId);
                if (chat) { chat.title = title.trim(); saveAndApplyData(); }
             } catch (error) { console.error("Could not generate title:", error); }
        };

        const getActiveChat = () => appData.chats.find(c => c.id === appData.activeChatId);
        
        const loadActiveChat = () => {
            const activeChat = getActiveChat();
            if (activeChat) renderMessages(activeChat.history);
        };
        
        const switchChat = (chatId) => {
            if (appData.activeChatId === chatId) return;
            appData.activeChatId = chatId;
            loadActiveChat();
            saveAndApplyData();
            closeMobileSidebar();
        };
        
        const closeMobileSidebar = () => {
            if (window.innerWidth <= 768) {
                sidebar.classList.remove('open');
                overlay.classList.remove('active');
            }
        };

        const startNewChat = () => {
            const newId = `chat-${Date.now()}`;
            const strings = uiStrings[appData.settings.language] || uiStrings.en;
            appData.chats.unshift({ id: newId, title: strings.newChat, history: [] });
            appData.activeChatId = newId;
            loadActiveChat();
            saveAndApplyData();
            closeMobileSidebar();
        };
        
        const deleteChat = (chatId) => {
            appData.chats = appData.chats.filter(c => c.id !== chatId);
            if (appData.activeChatId === chatId) {
                if (appData.chats.length > 0) {
                    appData.activeChatId = appData.chats[0].id;
                } else {
                    startNewChat();
                    return;
                }
            }
            loadActiveChat();
            saveAndApplyData();
        };

        const setActiveService = (service) => { appData.settings.activeService = service; saveAndApplyData(); };
        
        const hexToHsl = (H) => {
            if(!H) return [220, 85, 58];
            let r=0,g=0,b=0;
            if(H.length==4){r="0x"+H[1]+H[1];g="0x"+H[2]+H[2];b="0x"+H[3]+H[3];}
            else if(H.length==7){r="0x"+H[1]+H[2];g="0x"+H[3]+H[4];b="0x"+H[5]+H[6];}
            r/=255;g/=255;b/=255;
            let cmin=Math.min(r,g,b),cmax=Math.max(r,g,b),delta=cmax-cmin,h=0,s=0,l=0;
            if(delta==0)h=0;
            else if(cmax==r)h=((g-b)/delta)%6;
            else if(cmax==g)h=(b-r)/delta+2;
            else h=(r-g)/delta+4;
            h=Math.round(h*60);
            if(h<0)h+=360;
            l=(cmax+cmin)/2;s=delta==0?0:delta/(1-Math.abs(2*l-1));s=+(s*100).toFixed(1);l=+(l*100).toFixed(1);
            return [h,s,l];
        };

        init();
    });
</script>
</body>
</html>
